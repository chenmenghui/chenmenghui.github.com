---
title: 高并发和大流量解决方案考点
date: 2019-04-30
categories: 
- PHP
- PHP基础知识
tags: PHP基础知识
---

### php如何解决网站大流量与高并发的问题

- 重点
    - 高并发架构相关概念
    - 高并发解决方案案例


### 高并发的问题,需要关心的点

QPS:每秒钟请求或查询的数量,在互联网领域,指每秒响应的请求数(http请求)

吞吐量:单位时间内处理的请求数量(通常由qps和并发数决定)

PV:综合浏览量(page view),即页面浏览量或者点击量,一个访客在24小时内访问页面的数量.同一个人浏览网站同一页面,只记做以此PV

UV:独立访客(unique vistor),一定时间范围内相同访客多次访问网站,只计算为一个独立访客

带宽:计算带宽需要关注两个指标,峰值流量和页面的平均大小

日网站带宽 = PV / 统计时间(换算到秒) * 平均页面大小 (单位kb) * 8

压力测试
    - 测试能承受的最大的并发数
    - 测试最大承受的qbps值

### 测试工具

常用测试工具 ab(apache benchmark)
    - 创建多个并发访问线程,模拟多个访问者同时对某一个url地址进行访问.

ab的使用
    - 模拟并发请求100次,总共请求5000次
        - ab -c 100 -n 5000 http://xxx
    - 注意事项
        - 测试机器与被测试机器分开
        - 不要对线上服务做压力测试
        - 观察测试工具ab所在的机器,以及被测试的前端机的cpu,内存,网络等都不超过最高限度的75%

### 针对优化
        
QBS达到极限
    - 50
        - 小网站,无需优化
    - 100
        - 假设关系型数据库每次请求在0.01秒内完成
        - 假设一个页面只有一个sql查询,那么100qbs意味着1秒钟完成100次请求,但是此时我们并不能保证数据库查询能够完成100次
        - 方案
            - 数据库缓存层
            - 负载均衡
    - 800
        - 假设使用的是百兆带宽,意味着网站出口的实际带宽是8m左右
        - 假设每个页面只有10k,在这个并发条件下,百兆带宽已经吃完
        - 方案
            - cdn加速
            - 负载均衡
    - 1000
        - 假设使用memcache缓存数据库查询数据,每个页面对memcache的请求远大于直接对db的请求
        - memcache的悲观并发数在2w左右,但有可能在之前内网带宽已经吃光,表现出不稳定
        - 方案
    - 2000
        - 这个级别下,文件系统访问锁都成了灾难
        - 方案
            - 业务分离
            - 分布式存储

- 优化    
    - 流量优化
        - 防盗链处理
    - 前端优化
        - 减少http请求
        - 添加异步请求
        - 启用浏览器缓存和文件压缩
        - CDN加速
        - 建立独立的图片服务器
    - 服务端优化 
        - 页面静态化处理
        - 并发处理
        - 队列处理
    - 数据库优化
        - 数据库缓存 redis等
        - 分库分表,分区操作
        - 读写分离
        - 负载均衡
        
#### web资源防盗链

盗链概念
    - 盗链是指在自己的页面展示一些并不在自己服务器的内容
    - 获得他人服务器上的资源地址,绕过别人的资源展示页面,直接在自己的页面上向用户提供此内容
    - 小站盗用大站的图片,音乐,视频,软件等
    - 通过盗链可以减轻自己服务器的负担,因为真实的空间流量均是来自别人的服务器
    
防盗链
    - 防止他人通过技术手段绕过本站的资源展示页面,盗用本站的资源,让绕开本站资源展示页面的资源链接失效
    - 可以大大减轻服务器及带宽压力

防盗链工作原理
    - 通过referer或签名,网站可以检测目标网页访问的来源网页,如果是资源文件,则可以追踪到显示它的网页地址
    - 一旦检测到来源不是本站即进行阻止或返回指定的页面
    
    - referer
        - nginx模块ngx_http_referer_moudle用于阻挡来源非法的域名请求
            - valid_referers none|blocked|server_names|string ...
                - none: referer 来源头部为空的情况
                - blocked