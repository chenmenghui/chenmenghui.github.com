---
title: 正则匹配修饰符
date: 2019-12-19 01:26:15
categories: 正则
tags: 
- 正则
- 实用代码片段
---

### 被WIN下的CRLF换行符坑了一把

```php
// crlf模式
$str = <<<str
aaaa |
|
kkk |
str;

$pattern = "/\|\r$/m";
$replace = "i";
$res = preg_replace($pattern,$replace, $str);
echo ($res);
```
result
```
aaaa i
i
kkk |
```

回过头一看，居然忘了「\r」是什么了。

时隔数月又一次遇到这种问题，win（CRLF）下的回车换行是两个不可见字符~~~

### 终于写出一个把命令行查出结果转化成excel的小脚本了
```php
<?php

/**
 * Class TurnToExcel
 */
class TurnToExcel
{
    private $file_name;
    private $target_name;
    private $result;
    private $content;

    /**
     * @param string $file_name
     * @return $this
     */
    public function setFileName(string $file_name)
    {
        $this->file_name = $file_name;
        return $this;
    }

    /**
     * @param mixed $target_name
     * @return $this
     */
    public function setTargetName($target_name)
    {
        $this->target_name = $target_name;
        return $this;
    }


    /**
     * @param string $content
     * @return $this
     */
    public function setContent($content)
    {
        $this->content = $content;
        return $this;
    }

    public function getContent()
    {
        if (empty($this->content)) {
            $this->content = file_get_contents($this->file_name);
        }
        return $this;
    }

    /**
     * @return $this
     */
    public function run()
    {
        $this->getContent();
        $pattern = [
            "/(\r|\n|\r\n){2,}/",               // 删除多余空行
            "/\+(-+\+)*(\r|\n|\r\n)?/",         // 删除「+-----+----+」
            "/^\| */m",                         // 删除行首「|」
            "/ *\|(\r|\n|\r\n)/",               // 删除行尾「|」              // 为什么只有在「lf」换行符模式下才能用「/ *\|$/」
            "/ *\| */",                         // 把行内「|」替换成「tab」
            "/(\r\n|\r|\n)?$/",                 // 删除最后一个换行
        ];
        $replace = [
            "$1",
            "",
            "",
            "$1",
            "\t",
            "",
        ];
        $this->result = preg_replace($pattern, $replace, $this->content);
        return $this;
    }


    /**
     * @return $this
     */
    public function save()
    {
        if ($this->target_name) {
            file_put_contents($this->target_name, $this->result);
        }
        return $this;
    }

    /**
     * @return $this
     */
    public function dump()
    {
        echo $this->result;
        return $this;
    }


    /**
     * @return $this
     */
    public function download()
    {
        header("Content-Type:application/vnd.ms-excel");
        header("Content-Disposition:attachment;filename={$this->target_name}");
        echo iconv('utf-8', 'gbk//TRANSLIT', $this->result);
        return $this;
    }

}

(new TurnToExcel())
    ->setFileName('data.txt')
    ->setTargetName('data1.txt')
    ->run()
    ->save();
```

